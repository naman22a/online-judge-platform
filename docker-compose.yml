services:
    postgres:
        image: postgres:16-alpine
        container_name: leetcode-postgres
        env_file:
            - .env
        environment:
            POSTGRES_USER: ${POSTGRES_USER:-postgres}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
            POSTGRES_DB: leetcode
        ports:
            - '5432:5432'
        volumes:
            - pgdata:/var/lib/postgresql/data
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U postgres']
            interval: 10s
            timeout: 5s
            retries: 5

    redis:
        image: redis:7-alpine
        container_name: leetcode-redis
        ports:
            - '6379:6379'
        volumes:
            - redis-data:/data
        healthcheck:
            test: ['CMD', 'redis-cli', 'ping']
            interval: 10s
            timeout: 5s
            retries: 5

    prisma-migrate:
        build:
            context: .
            dockerfile: Dockerfile.base
            args:
                SERVICE_NAME: problems-service
                DATABASE_URL: ${DATABASE_URL}
        container_name: leetcode-prisma-migrate
        command: sh -c "cd /app/packages/database && npx prisma migrate deploy"
        environment:
            - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/leetcode?schema=public
        depends_on:
            postgres:
                condition: service_healthy
        restart: on-failure

    # ============================
    #        API GATEWAY
    # ============================
    api-gateway:
        build:
            context: .
            dockerfile: Dockerfile.base
            args:
                SERVICE_NAME: api-gateway
                DATABASE_URL: ${DATABASE_URL}
        image: naman22a/leetcode-api-gateway
        container_name: leetcode-api-gateway
        ports:
            - '5000:5000'
        environment:
            - NODE_ENV=production
            - API_GATEWAY_PORT=5000
            - USERS_SERVICE_PORT=5001
            - AUTH_SERVICE_PORT=5002
            - PROBLEMS_SERVICE_PORT=5003
            - TAGS_SERVICE_PORT=5004
            - COMPANIES_SERVICE_PORT=5005
            - SUBMISSIONS_SERVICE_PORT=5006
            - EXECUTION_SERVICE_PORT=5007
            - CLIENT_URL=http://localhost:3000
            - SERVER_URL=http://localhost:5000
            - NEXT_PUBLIC_API_ENDPOINT=http://localhost:5000
            - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/leetcode?schema=public
            - REDIS_HOST=redis
            - REDIS_PORT=6379
            - ACCESS_TOKEN_SECRET=super_secret_access_token_secret
            - REFRESH_TOKEN_SECRET=super_secret_refresh_token_secret
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
            prisma-migrate:
                condition: service_completed_successfully
        restart: unless-stopped

    # ============================
    #        USERS SERVICE
    # ============================
    users-service:
        build:
            context: .
            dockerfile: Dockerfile.base
            args:
                SERVICE_NAME: users-service
                DATABASE_URL: ${DATABASE_URL}
        image: naman22a/leetcode-users-service
        container_name: leetcode-users-service
        ports:
            - '5001:5001'
        environment:
            - NODE_ENV=production
            - API_GATEWAY_PORT=5000
            - USERS_SERVICE_PORT=5001
            - AUTH_SERVICE_PORT=5002
            - PROBLEMS_SERVICE_PORT=5003
            - TAGS_SERVICE_PORT=5004
            - COMPANIES_SERVICE_PORT=5005
            - SUBMISSIONS_SERVICE_PORT=5006
            - EXECUTION_SERVICE_PORT=5007
            - CLIENT_URL=http://localhost:3000
            - SERVER_URL=http://localhost:5000
            - NEXT_PUBLIC_API_ENDPOINT=http://localhost:5000
            - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/leetcode?schema=public
            - REDIS_HOST=redis
            - REDIS_PORT=6379
            - ACCESS_TOKEN_SECRET=super_secret_access_token_secret
            - REFRESH_TOKEN_SECRET=super_secret_refresh_token_secret
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
            prisma-migrate:
                condition: service_completed_successfully
        restart: unless-stopped

    # ============================
    #        AUTH SERVICE
    # ============================
    auth-service:
        build:
            context: .
            dockerfile: Dockerfile.base
            args:
                SERVICE_NAME: auth-service
                DATABASE_URL: ${DATABASE_URL}
        image: naman22a/leetcode-auth-service
        container_name: leetcode-auth-service
        ports:
            - '5002:5002'
        environment:
            - NODE_ENV=production
            - API_GATEWAY_PORT=5000
            - USERS_SERVICE_PORT=5001
            - AUTH_SERVICE_PORT=5002
            - PROBLEMS_SERVICE_PORT=5003
            - TAGS_SERVICE_PORT=5004
            - COMPANIES_SERVICE_PORT=5005
            - SUBMISSIONS_SERVICE_PORT=5006
            - EXECUTION_SERVICE_PORT=5007
            - CLIENT_URL=http://localhost:3000
            - SERVER_URL=http://localhost:5000
            - NEXT_PUBLIC_API_ENDPOINT=http://localhost:5000
            - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/leetcode?schema=public
            - REDIS_HOST=redis
            - REDIS_PORT=6379
            - ACCESS_TOKEN_SECRET=super_secret_access_token_secret
            - REFRESH_TOKEN_SECRET=super_secret_refresh_token_secret
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
            prisma-migrate:
                condition: service_completed_successfully
        restart: unless-stopped

    # ============================
    #        PROBLEMS SERVICE
    # ============================
    problems-service:
        build:
            context: .
            dockerfile: Dockerfile.base
            args:
                SERVICE_NAME: problems-service
                DATABASE_URL: ${DATABASE_URL}
        image: naman22a/leetcode-problems-service
        container_name: leetcode-problems-service
        ports:
            - '5003:5003'
        environment:
            - NODE_ENV=production
            - API_GATEWAY_PORT=5000
            - USERS_SERVICE_PORT=5001
            - AUTH_SERVICE_PORT=5002
            - PROBLEMS_SERVICE_PORT=5003
            - TAGS_SERVICE_PORT=5004
            - COMPANIES_SERVICE_PORT=5005
            - SUBMISSIONS_SERVICE_PORT=5006
            - EXECUTION_SERVICE_PORT=5007
            - CLIENT_URL=http://localhost:3000
            - SERVER_URL=http://localhost:5000
            - NEXT_PUBLIC_API_ENDPOINT=http://localhost:5000
            - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/leetcode?schema=public
            - REDIS_HOST=redis
            - REDIS_PORT=6379
            - ACCESS_TOKEN_SECRET=super_secret_access_token_secret
            - REFRESH_TOKEN_SECRET=super_secret_refresh_token_secret
        depends_on:
            postgres:
                condition: service_healthy
            prisma-migrate:
                condition: service_completed_successfully
        restart: unless-stopped

    # ============================
    #        TAGS SERVICE
    # ============================
    tags-service:
        build:
            context: .
            dockerfile: Dockerfile.base
            args:
                SERVICE_NAME: tags-service
                DATABASE_URL: ${DATABASE_URL}
        image: naman22a/leetcode-tags-service
        container_name: leetcode-tags-service
        ports:
            - '5004:5004'
        environment:
            - NODE_ENV=production
            - API_GATEWAY_PORT=5000
            - USERS_SERVICE_PORT=5001
            - AUTH_SERVICE_PORT=5002
            - PROBLEMS_SERVICE_PORT=5003
            - TAGS_SERVICE_PORT=5004
            - COMPANIES_SERVICE_PORT=5005
            - SUBMISSIONS_SERVICE_PORT=5006
            - EXECUTION_SERVICE_PORT=5007
            - CLIENT_URL=http://localhost:3000
            - SERVER_URL=http://localhost:5000
            - NEXT_PUBLIC_API_ENDPOINT=http://localhost:5000
            - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/leetcode?schema=public
            - REDIS_HOST=redis
            - REDIS_PORT=6379
            - ACCESS_TOKEN_SECRET=super_secret_access_token_secret
            - REFRESH_TOKEN_SECRET=super_secret_refresh_token_secret
        depends_on:
            postgres:
                condition: service_healthy
            prisma-migrate:
                condition: service_completed_successfully
        restart: unless-stopped

    # ============================
    #        COMPANIES SERVICE
    # ============================
    companies-service:
        build:
            context: .
            dockerfile: Dockerfile.base
            args:
                SERVICE_NAME: companies-service
                DATABASE_URL: ${DATABASE_URL}
        image: naman22a/leetcode-companies-service
        container_name: leetcode-companies-service
        ports:
            - '5005:5005'
        environment:
            - NODE_ENV=production
            - API_GATEWAY_PORT=5000
            - USERS_SERVICE_PORT=5001
            - AUTH_SERVICE_PORT=5002
            - PROBLEMS_SERVICE_PORT=5003
            - TAGS_SERVICE_PORT=5004
            - COMPANIES_SERVICE_PORT=5005
            - SUBMISSIONS_SERVICE_PORT=5006
            - EXECUTION_SERVICE_PORT=5007
            - CLIENT_URL=http://localhost:3000
            - SERVER_URL=http://localhost:5000
            - NEXT_PUBLIC_API_ENDPOINT=http://localhost:5000
            - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/leetcode?schema=public
            - REDIS_HOST=redis
            - REDIS_PORT=6379
            - ACCESS_TOKEN_SECRET=super_secret_access_token_secret
            - REFRESH_TOKEN_SECRET=super_secret_refresh_token_secret
        depends_on:
            postgres:
                condition: service_healthy
            prisma-migrate:
                condition: service_completed_successfully
        restart: unless-stopped

    # ============================
    #        SUBMISSIONS SERVICE
    # ============================
    submissions-service:
        build:
            context: .
            dockerfile: Dockerfile.base
            args:
                SERVICE_NAME: submissions-service
                DATABASE_URL: ${DATABASE_URL}
        image: naman22a/leetcode-submissions-service
        container_name: leetcode-submissions-service
        ports:
            - '5006:5006'
        environment:
            - NODE_ENV=production
            - API_GATEWAY_PORT=5000
            - USERS_SERVICE_PORT=5001
            - AUTH_SERVICE_PORT=5002
            - PROBLEMS_SERVICE_PORT=5003
            - TAGS_SERVICE_PORT=5004
            - COMPANIES_SERVICE_PORT=5005
            - SUBMISSIONS_SERVICE_PORT=5006
            - EXECUTION_SERVICE_PORT=5007
            - CLIENT_URL=http://localhost:3000
            - SERVER_URL=http://localhost:5000
            - NEXT_PUBLIC_API_ENDPOINT=http://localhost:5000
            - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/leetcode?schema=public
            - REDIS_HOST=redis
            - REDIS_PORT=6379
            - ACCESS_TOKEN_SECRET=super_secret_access_token_secret
            - REFRESH_TOKEN_SECRET=super_secret_refresh_token_secret
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
            prisma-migrate:
                condition: service_completed_successfully
        restart: unless-stopped

    # ============================
    #        EXECUTION SERVICE
    # ============================
    execution-service:
        build:
            context: .
            dockerfile: Dockerfile.base
            args:
                SERVICE_NAME: execution-service
                DATABASE_URL: ${DATABASE_URL}
        image: naman22a/leetcode-execution-service
        container_name: leetcode-execution-service
        ports:
            - '5007:5007'
        environment:
            - NODE_ENV=production
            - API_GATEWAY_PORT=5000
            - USERS_SERVICE_PORT=5001
            - AUTH_SERVICE_PORT=5002
            - PROBLEMS_SERVICE_PORT=5003
            - TAGS_SERVICE_PORT=5004
            - COMPANIES_SERVICE_PORT=5005
            - SUBMISSIONS_SERVICE_PORT=5006
            - EXECUTION_SERVICE_PORT=5007
            - CLIENT_URL=http://localhost:3000
            - SERVER_URL=http://localhost:5000
            - NEXT_PUBLIC_API_ENDPOINT=http://localhost:5000
            - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/leetcode?schema=public
            - REDIS_HOST=redis
            - REDIS_PORT=6379
            - ACCESS_TOKEN_SECRET=super_secret_access_token_secret
            - REFRESH_TOKEN_SECRET=super_secret_refresh_token_secret
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
            prisma-migrate:
                condition: service_completed_successfully
        restart: unless-stopped

    # client:
    #     build:
    #         context: .
    #         dockerfile: Dockerfile.web
    #     image: naman22a/leetcode-client
    #     container_name: leetcode-client
    #     restart: unless-stopped
    #     ports:
    #         - "80:80"
    #     environment:
    #         - NODE_ENV=production
    #         - VITE_API_ENDPOINT=http://api-gateway:5000

volumes:
    pgdata:
    redis-data:

networks:
    default:
        name: leetcode-network
